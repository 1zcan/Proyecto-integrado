{% extends "base.html" %}

{% block title %}Auditoría del sistema{% endblock %}

{% block content %}
<h4 class="mb-3">Bitácora de acciones</h4>
<p class="text-muted small">
    Registro de modificaciones sobre datos sensibles de pacientes, partos y recién nacidos.
</p>

<!-- Filtros -->
<div class="card mb-3 shadow-sm border-0">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">

      <div class="col-md-3">
        <label class="form-label small">Modelo</label>
        <input type="text"
               name="modelo"
               class="form-control"
               placeholder="Ej: Madre, RecienNacido"
               value="{{ filtro_modelo }}">
      </div>

      <div class="col-md-3">
        <label class="form-label small">Acción</label>
        <select name="accion" class="form-select">
          {% for value, label in acciones_disponibles %}
            <option value="{{ value }}" {% if value == filtro_accion %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label small">Buscar en detalle / motivo</label>
        <input type="text"
               name="q"
               class="form-control"
               placeholder="Ej: 'Motivo', RUT, ID, texto..."
               value="{{ filtro_q }}">
      </div>

      <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">
          <i class="bi bi-search"></i> Filtrar
        </button>
      </div>

    </form>
  </div>
</div>

<div class="card shadow-sm card-audit">
    <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle table-hover">
            <thead class="table-light">
                <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Acción</th>
                    <th>Modelo</th>
                    <th>ID objeto</th>
                    <th style="width: 260px;">Detalle / Motivo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for log in logs %}
                <!-- Fila principal -->
                <tr>
                    <td class="text-nowrap">{{ log.timestamp|date:"d/m/Y H:i" }}</td>

                    <!-- USUARIO: nombre completo, username o 'Sistema' -->
                    <td>
                        {% if log.usuario %}
                            {{ log.usuario.get_full_name|default:log.usuario.username }}
                        {% else %}
                            Sistema
                        {% endif %}
                    </td>
                    
                    <td>
                        {% if log.accion == 'create' %}
                            <span class="badge bg-success-subtle text-success-emphasis">
                        {% elif log.accion == 'update' %}
                            <span class="badge bg-warning-subtle text-warning-emphasis">
                        {% elif log.accion == 'delete' %}
                            <span class="badge bg-danger-subtle text-danger-emphasis">
                        {% else %}
                            <span class="badge bg-secondary-subtle text-secondary-emphasis">
                        {% endif %}
                            {{ log.get_accion_display }}
                        </span>
                    </td>
                    
                    <td>{{ log.modelo }}</td>
                    <td>{{ log.objeto_id }}</td>


                    <!-- Resumen del detalle, con "..." -->
                    <td>
                        <div class="small text-muted text-truncate" style="max-width: 250px;">
                            {{ log.detalle|default:"-" }}
                        </div>
                    </td>

                    <!-- Botón para ver más -->
                    <td class="text-end text-nowrap">
                        {% if log.detalle %}
                        <button class="btn btn-sm btn-outline-secondary"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#logDetalle{{ log.id }}"
                                aria-expanded="false"
                                aria-controls="logDetalle{{ log.id }}">
                            Ver detalle
                        </button>
                        {% endif %}
                    </td>
                </tr>

                <!-- Fila colapsable con el detalle completo -->
                {% if log.detalle %}
                <tr class="collapse bg-light" id="logDetalle{{ log.id }}">
                    <td colspan="8">
                        <div class="p-3 small">
                            <strong>Detalle completo:</strong><br>
                            <span style="white-space: pre-wrap; word-break: break-word;">
                                {{ log.detalle }}
                            </span>
                        </div>
                    </td>
                </tr>
                {% endif %}
            {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-3">
                        Aún no hay registros de auditoría.
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if is_paginated %}
<nav class="mt-3">
  <ul class="pagination pagination-sm justify-content-end">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.previous_page_number }}{% if filtro_modelo %}&modelo={{ filtro_modelo }}{% endif %}{% if filtro_accion %}&accion={{ filtro_accion }}{% endif %}{% if filtro_q %}&q={{ filtro_q }}{% endif %}">
           Anterior
        </a>
      </li>
    {% endif %}
    <li class="page-item disabled">
      <span class="page-link">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
      </span>
    </li>
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.next_page_number }}{% if filtro_modelo %}&modelo={{ filtro_modelo }}{% endif %}{% if filtro_accion %}&accion={{ filtro_accion }}{% endif %}{% if filtro_q %}&q={{ filtro_q }}{% endif %}">
           Siguiente
        </a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<style>
    h4 {
        font-weight: 600;
        color: #212529;
    }

    .card-audit {
        border: none;
        border-radius: 8px;
        overflow: hidden;
    }

    .card-audit .table thead {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .card-audit .table th {
        font-weight: 500;
        color: #495057;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }

    .card-audit .table td {
        font-size: 0.9rem;
        color: #343a40;
        vertical-align: middle;
    }

    .badge {
        font-weight: 500;
    }

    .pagination .page-link {
        border-radius: 4px;
        margin: 0 2px;
        color: #007bff;
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
    }
</style>
{% endblock %}
