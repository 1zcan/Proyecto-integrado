{% extends "base.html" %}

{% block title %}Reporte REM {% if datos.periodo %}{{ datos.periodo }}{% endif %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Reporte Mensual Estadístico (REM)</h1>
    <p class="text-muted mb-0">Periodo: <strong>{% if datos.periodo %}{{ datos.periodo }}{% else %}Seleccione un Periodo{% endif %}</strong></p>
</div>

<div class="card shadow-sm border-0 mb-4" style="border-radius: 8px;">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="id_anio" class="form-label">Año</label>
                <select name="anio" id="id_anio" class="form-select">
                    {% for y in anios_disponibles %}
                        <option value="{{ y }}" {% if y|stringformat:"s" == selected_anio %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="id_mes" class="form-label">Mes</label>
                <select name="mes" id="id_mes" class="form-select">
                    <option value="">-- Seleccionar Mes --</option>
                    {% for m, label in meses_disponibles %}
                        <option value="{{ m }}" {% if m|stringformat:"s" == selected_mes %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4 d-flex gap-2 justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-filter"></i> Generar Reporte
                </button>
                <button type="button" id="btnExportExcel" class="btn btn-success" {% if not datos %}disabled{% endif %}>
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </button>
                <button type="button" id="btnExportPDF" class="btn btn-danger" {% if not datos %}disabled{% endif %}>
                    <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                </button>
            </div>
        </form>
    </div>
</div>

{% if datos %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm border-0" style="border-radius: 8px;">
            <div class="card-body">
                
                <div class="mb-4">
                    <h3 class="h5 section-title">REM A11 - Tamizajes Madre</h3>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-sm">
                            <tbody>
                                <tr>
                                    <td>Tamizajes **VIH Positivos**</td>
                                    <td><strong>{{ datos.rem_a11.tamizajes_ih_positivos }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Tamizajes **VDRL Positivos** (Sífilis)</td>
                                    <td><strong>{{ datos.rem_a11.tamizajes_vdrl_positivos }}</strong></td>
                                </tr>
                                <tr>
                                    <td>VDRL Positivos con **Tratamiento Completo**</td>
                                    <td><strong>{{ datos.rem_a11.tamizajes_vdrl_con_tratamiento }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Tamizajes **Hepatitis B Positivos**</td>
                                    <td><strong>{{ datos.rem_a11.tamizajes_hepb_positivos }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <hr class="my-4">

                <div class="mb-4">
                    <h3 class="h5 section-title">REM A21 - Modelo Atención Parto</h3>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Indicador</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Total Partos Registrados</td>
                                    <td><strong>{{ datos.rem_a21.total_partos }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Partos con Acompañamiento</td>
                                    <td><strong>{{ datos.rem_a21.partos_con_acompanamiento }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <h5 class="h6 mt-3">Desglose por Tipo de Parto</h5>
                        <table class="table table-sm">
                            <tbody>
                            {% for desglose in datos.rem_a21.desglose_partos %}
                                <tr>
                                    <td>Tipo {{ desglose.tipo_parto__valor }}</td>
                                    <td>{{ desglose.total }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">No hay datos de desglose de partos.</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        <h5 class="h6 mt-3">Clasificación Robson</h5>
                        <table class="table table-sm">
                            <tbody>
                            {% for desglose in datos.rem_a21.desglose_robson %}
                                <tr>
                                    <td>Grupo {{ desglose.clasificacion_robson__grupo }}</td>
                                    <td>{{ desglose.total }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">No hay datos de Clasificación Robson.</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <hr class="my-4">

                <div class="mb-4">
                    <h3 class="h5 section-title">REM A24 - Atención Recién Nacido</h3>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-sm">
                            <tbody>
                                <tr>
                                    <td>Total Recién Nacidos</td>
                                    <td><strong>{{ datos.rem_a24.total_rn }}</strong></td>
                                </tr>
                                <tr>
                                    <td>RN con Lactancia Materna en 60 min</td>
                                    <td><strong>{{ datos.rem_a24.rn_con_lm_60min }}</strong></td>
                                </tr>
                                <tr>
                                    <td>RN con Bajo Peso (<2500g)</td>
                                    <td><strong>{{ datos.rem_a24.rn_bajo_peso }}</strong></td>
                                </tr>
                                <tr>
                                    <td>RN con Apgar < 7 (5 min)</td>
                                    <td><strong>{{ datos.rem_a24.rn_apgar_bajo }}</strong></td>
                                </tr>
                                <tr>
                                    <td>RN con Reanimación (Básica o Avanzada)</td>
                                    <td><strong>{{ datos.rem_a24.rn_con_reanimacion }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Profilaxis Vitamina K</td>
                                    <td><strong>{{ datos.rem_a24.rn_con_vitamina_k }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Profilaxis Oftálmica</td>
                                    <td><strong>{{ datos.rem_a24.rn_con_prof_oftalmica }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

{% elif selected_anio and selected_mes %}
<div class="alert alert-warning text-center" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    No se encontraron datos para el periodo seleccionado ({{ selected_mes }}-{{ selected_anio }}).
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    function getQueryParams() {
        const form = document.querySelector('form');
        const params = new URLSearchParams(new FormData(form));
        return params.toString();
    }
    
    const btnExcel = document.getElementById('btnExportExcel');
    if (btnExcel) {
        btnExcel.addEventListener('click', function() {
            let params = getQueryParams();
            params += '&format=excel'; // Añade el formato Excel
            window.location.href = `?${params}`;
        });
    }

    const btnPDF = document.getElementById('btnExportPDF');
    if (btnPDF) {
        btnPDF.addEventListener('click', function() {
            let params = getQueryParams();
            params += '&format=pdf'; // Añade el formato PDF
            window.location.href = `?${params}`;
        });
    }
});
</script>
{% endblock %}