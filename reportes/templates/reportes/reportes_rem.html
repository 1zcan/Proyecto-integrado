{% extends "base.html" %}

{% block title %}
    {% if vista_elegida == 'A11' %}
        Reporte REM A11 (Madre)
    {% elif vista_elegida == 'A21' %}
        Reporte REM A21 (Parto)
    {% elif vista_elegida == 'A24' %}
        Reporte REM A24 (Recién Nacido)
    {% else %}
        Reportes REM (A11, A21, A24)
    {% endif %}
{% endblock %}

{% block content %}

{% if vista_elegida == 'A11' %}
    <h2 class="mb-3">Reporte REM A11 (Madre)</h2>
    <p class="text-muted mb-4">Detalle de indicadores de Tamizajes (A11) para el período seleccionado.</p>
{% elif vista_elegida == 'A21' %}
    <h2 class="mb-3">Reporte REM A21 (Parto)</h2>
    <p class="text-muted mb-4">Detalle de indicadores de Parto y Robson (A21) para el período seleccionado.</p>
{% elif vista_elegida == 'A24' %}
    <h2 class="mb-3">Reporte REM A24 (Recién Nacido)</h2>
    <p class="text-muted mb-4">Detalle de indicadores de Recién Nacido (A24) para el período seleccionado.</p>
{% else %} <h2 class="mb-3">Reportes REM (A11, A21, A24)</h2>
    <p class="text-muted mb-4">Consolidado de indicadores REM para el período seleccionado.</p>
{% endif %}


<div class="card shadow-sm border-0 mb-4 rem-form">
    <div class="card-body">
        <form method="get" action="" id="filtroForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="{{ form.anio.id_for_label }}" class="form-label">Año</label>
                    {{ form.anio }}
                </div>
                <div class="col-md-3">
                    <label for="{{ form.mes.id_for_label }}" class="form-label">Mes</label>
                    {{ form.mes }}
                </div>
                <div class="col-md-3">
                    <label for="{{ form.vista.id_for_label }}" class="form-label">Vista</label>
                    {{ form.vista }}
                </div>
                <div class="col-md-3 d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-filter"></i> Filtrar
                    </button>
                    <button type="button" id="btnExportExcel" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                    </button>
                    <button type="button" id="btnExportPDF" class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if datos %}
    <div class="card shadow-sm border-0 rem-results">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0">
                {% if vista_elegida == 'A11' %}
                    Resultados REM A11 para {{ datos.periodo }}
                {% elif vista_elegida == 'A21' %}
                    Resultados REM A21 para {{ datos.periodo }}
                {% elif vista_elegida == 'A24' %}
                    Resultados REM A24 para {{ datos.periodo }}
                {% else %}
                    Resultados Consolidados para {{ datos.periodo }}
                {% endif %}
            </h5>
        </div>
        <div class="card-body p-4">

            {% if vista_elegida == 'CONSOLIDADO' or vista_elegida == 'A11' %}
            <div class="mb-4">
                <h3 class="h5 section-title">REM A11 - Tamizajes Madre</h3>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <tbody>
                            <tr>
                                <td>Tamizajes VIH Positivos</td>
                                <td><strong>{{ datos.rem_a11.tamizajes_vih_positivos }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}


            {% if vista_elegida == 'CONSOLIDADO' or vista_elegida == 'A21' %}
            <div class="mb-4">
                <h3 class="h5 section-title">REM A21 - Modelo Atención Parto</h3>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <tbody>
                            <tr>
                                <td>Total Partos</td>
                                <td><strong>{{ datos.rem_a21.total_partos }}</strong></td>
                            </tr>
                            
                            {% for desglose in datos.rem_a21.desglose_partos %}
                            <tr>
                                <td style="padding-left: 2rem;">↳ {{ desglose.tipo_parto__valor }}</td>
                                <td><strong>{{ desglose.total }}</strong></td>
                            </tr>
                            {% endfor %}

                            <tr>
                                <td colspan="2" class="text-muted pt-3" style="font-size: 0.9rem;">Clasificación Robson:</td>
                            </tr>
                            {% for desglose in datos.rem_a21.desglose_robson %}
                            <tr>
                                <td style="padding-left: 2rem;">↳ Grupo {{ desglose.clasificacion_robson__grupo }}</td>
                                <td><strong>{{ desglose.total }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-muted" style="padding-left: 2rem;">(Sin datos de Robson)</td>
                            </tr>
                            {% endfor %}
                            
                            <tr class="pt-3">
                                <td>Partos con Acompañamiento</td>
                                <td><strong>{{ datos.rem_a21.partos_con_acompanamiento }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {% if vista_elegida == 'CONSOLIDADO' or vista_elegida == 'A24' %}
            <div>
                <h3 class="h5 section-title">REM A24 - Atención Recién Nacido</h3>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <tbody>
                            <tr>
                                <td>Total Recién Nacidos</td>
                                <td><strong>{{ datos.rem_a24.total_rn }}</strong></td>
                            </tr>
                            <tr>
                                <td>RN con Lactancia (60 min)</td>
                                <td><strong>{{ datos.rem_a24.rn_con_lm_60min }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            
        </div>
    </div>

{% elif request.GET.anio %}
    <div class="alert alert-info" role="alert">
        <p class="mb-0">No se encontraron datos para el período seleccionado.</p>
    </div>
{% else %}
    <div class="alert alert-secondary" role="alert">
        <p class="mb-0">Seleccione un año y un mes para generar el reporte.</p>
    </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filtroForm');
    
    document.getElementById('btnExportExcel').addEventListener('click', function() {
        const params = new URLSearchParams(new FormData(form));
        params.append('format', 'excel');
        window.location.href = `?${params.toString()}`;
    });

    document.getElementById('btnExportPDF').addEventListener('click', function() {
        const params = new URLSearchParams(new FormData(form));
        params.append('format', 'pdf');
        window.location.href = `?${params.toString()}`;
    });
});
</script>

{% endblock %}


{% block styles %}
<style>

    .rem-form form select {
        display: block;
        width: 100%;
        padding: 0.375rem 2.25rem 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }

    .rem-form form select:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }

 
    .rem-results .section-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: #343a40;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }

   
    .rem-results .table {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden; 
    }

    .rem-results .table td {
        padding: 0.8rem 1rem;
        font-size: 0.95rem;
    }

 
    .rem-results .table td:first-child {
        color: #495057; 
    }
</style>
{% endblock %}