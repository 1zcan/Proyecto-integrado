{% extends "base.html" %}

{% block title %}Listado de Partos - HCHM{% endblock %}

{% block content %}

{% with rol=user.perfil.rol %}

<div class="card shadow-sm border-0">
    
    <div class="card-header bg-white py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Listado de Partos Registrados</h2>

            {# ANTES: madre_lista #}
            <a href="{% url 'madre:madre_lista' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Volver al Listado de Madres
            </a>

        </div>
    </div>

    <div class="card-body">
        
        <form method="get" class="row g-3 align-items-end mb-4 parto-list-filters">

            <div class="col-md-3">
                <label class="form-label small">Fecha Desde</label>
                <input type="date" name="filtro_fecha_inicio" 
                       class="form-control"
                       value="{{ request.GET.filtro_fecha_inicio }}">
            </div>

            <div class="col-md-3">
                <label class="form-label small">Fecha Hasta</label>
                <input type="date" name="filtro_fecha_fin"
                       class="form-control"
                       value="{{ request.GET.filtro_fecha_fin }}">
            </div>

            <div class="col-md-2">
                <label class="form-label small">Tipo</label>
                <select name="filtro_tipo" class="form-select">
                    <option value="">Todos los Tipos</option>
                    {% for tipo in tipos_parto %}
                        <option value="{{ tipo.id }}"
                                {% if request.GET.filtro_tipo == tipo.id|stringformat:"s" %}selected{% endif %}>
                            {{ tipo.valor }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label small">Establecimiento</label>
                <select name="filtro_establecimiento" class="form-select">
                    <option value="">Todos los Establ.</option>
                    {% for est in establecimientos %}
                        <option value="{{ est.id }}"
                                {% if request.GET.filtro_establecimiento == est.id|stringformat:"s" %}selected{% endif %}>
                            {{ est.valor }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-1">
                <button type="submit" class="btn btn-primary btn-sm w-100">Filtrar</button>
            </div>

        </form>

        <div class="table-responsive parto-list-table">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>ID Parto</th>
                        <th>Madre (RUT)</th>
                        <th>Fecha/Hora</th>
                        <th>Tipo Parto</th>
                        <th>EG (sem)</th>
                        <th>Establecimiento</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for parto in partos %}
                    <tr>
                        <td>{{ parto.id }}</td>
                        <td>{{ parto.madre.nombre_completo }} ({{ parto.madre.rut }})</td>
                        <td>{{ parto.fecha|date:"d-m-Y" }} {{ parto.hora }}</td>
                        <td>{{ parto.tipo_parto.valor }}</td>
                        <td>{{ parto.edad_gestacional_semanas }}</td>
                        <td>{{ parto.establecimiento.valor }}</td>

                        <td>

                            {% if rol == 'profesional_salud' or rol == 'ti_informatica' %}

                                {# ANTES: parto_editar #}
                                <a href="{% url 'parto:parto_editar' pk=parto.pk %}" class="btn btn-sm btn-outline-primary" title="Registro ClÃ­nico">
                                    <i class="bi bi-clipboard-data"></i>
                                </a>

                                {# ANTES: parto_modelo_atencion #}
                                <a href="{% url 'parto:parto_modelo_atencion' pk=parto.pk %}" class="btn btn-sm btn-outline-secondary" title="REM A21">
                                    <i class="bi bi-person-check"></i>
                                </a>

                                {# ANTES: parto_robson #}
                                <a href="{% url 'parto:parto_robson' pk=parto.pk %}" class="btn btn-sm btn-outline-secondary" title="Robson">
                                    <i class="bi bi-bar-chart-steps"></i>
                                </a>
                                
                            {% endif %}

                            {% if rol == 'profesional_salud' %}
                            {# ANTES: parto_observaciones #}
                            <a href="{% url 'parto:parto_observaciones' parto_pk=parto.pk %}" class="btn btn-sm btn-outline-warning" title="Firmar Observaciones">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% endif %}

                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-3">
                            No se encontraron registros de partos.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</div>

{% endwith %}

{% endblock %}

{% block styles %}
<style>
    .parto-list-filters label {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}
